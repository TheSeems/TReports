{% extends "base.html" %}
{% load static %}
{% load martortags %}

{% block custom_style %}
    <link rel="stylesheet" href="{% static "main.css" %}">
    <link href="{% static 'plugins/css/ace.min.css' %}" type="text/css" media="all" rel="stylesheet"/>
    <link href="{% static 'plugins/css/semantic.min.css' %}" type="text/css" media="all" rel="stylesheet"/>
    <link href="{% static 'plugins/css/resizable.min.css' %}" type="text/css" media="all" rel="stylesheet"/>
    <link href="{% static 'martor/css/martor.min.css' %}" type="text/css" media="all" rel="stylesheet"/>
{% endblock %}

{% block custom_scripts %}
    <script type="text/javascript" src="{% static 'plugins/js/ace.js' %}"></script>
    <script type="text/javascript" src="{% static 'plugins/js/semantic.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'plugins/js/mode-markdown.js' %}"></script>
    <script type="text/javascript" src="{% static 'plugins/js/ext-language_tools.js' %}"></script>
    <script type="text/javascript" src="{% static 'plugins/js/theme-github.js' %}"></script>
    <script type="text/javascript" src="{% static 'plugins/js/typo.js' %}"></script>
    <script type="text/javascript" src="{% static 'plugins/js/spellcheck.js' %}"></script>
    <script type="text/javascript" src="{% static 'plugins/js/highlight.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'plugins/js/resizable.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'plugins/js/emojis.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'martor/js/martor.min.js' %}"></script>
    <script type="text/javascript">
        let currentUrl = window.location.href;
        const indices = [];
        for (let i = 0; i < currentUrl.length; i++) if (currentUrl[i] === "/") indices.push(i);
        currentUrl = currentUrl.substring(0, (indices[(indices.length) - 2]) + 1);
        const url = new URL(currentUrl);

        function toggle_value(name, toggled_value) {
            if (!url.searchParams.has(name)) {
                url.searchParams.set(name, toggled_value);
            } else {
                let arr = url.searchParams.get(name).split(',');
                arr = arr.includes(toggled_value)
                    ? arr.filter(function (value) {
                        return value !== toggled_value;
                    })
                    : arr.concat(toggled_value);
                arr = arr.filter(n => n !== "");

                if (arr.length === 0) url.searchParams.delete(name)
                else url.searchParams.set(toggled_value, arr.join(',').toString())
            }

            window.location.href = url.href
        }

        function toggle_tag(tag_id) {
            toggle_value("tags", tag_id)
        }

        function toggle_filter(status) {
            toggle_value("status", status)
        }

        $('.collapse').collapse('hide')
    </script>
{% endblock %}


{% block title %}{{ report.name }}{% endblock %}

{% block content %}
    <div class="container report md-5">
        <h1 class="report-head ma-5">
            {{ report.name }}
            {% if user.is_staff %}
                <a href="{% url "admin:reports_report_change" report.id %}"><small>
                    #{{ report.id }}</small></a>
            {% endif %}
        </h1>

        <div class="row report-meta">
            <div class="col-md">
                <!-- Status -->
                <h4>Статус</h4>
                {% include "reports/report-status.html" with name=report.status %}
            </div>

            {% if report.tags.all|length > 0 %}
                <div class="col-md">
                    <!-- Tags -->
                    <h4>Теги</h4>
                    {% for tag in report.tags.all %}
                        <span class="mr-1 report-tag badge badge-dark"
                              onclick="toggle_tag('{{ tag.id }}')">{{ tag }}</span>
                    {% endfor %}
                </div>
            {% endif %}

            <div class="col-md">
                <!-- Author -->
                <h4>Автор</h4>
                <span class="author">{% include "reports/ucard.html" with user=report.author %}</span>
            </div>
        </div>

    </div>

    <div class="container ma-5">
        <h3 class="report-steps">Шаги воспроизведения</h3>
        <p>{{ report.steps|safe_markdown }}</p>

        <h3 class="report-steps">Фактический результат</h3>
        <p>{{ report.fact }}</p>

        <h3 class="report-steps">Ожидаемый результат</h3>
        <p>{{ report.expect }}</p>
    </div>

    {% if report.events.all|length != 0 %}
        <div class="container ma-5">
            <!-- Events -->
            <h3>События <a class="text-black-50 ml-2 fa fa-bars" data-toggle="collapse" href="#events" aria-expanded="false" aria-controls="events"></a></h3>
            <div class="collapse" id="events">
                {% for event in events %}
                    <div class="card" style="margin-bottom: 1vh">
                        <div class="card-body">
                            {% if event.status %}
                                {% include "reports/events/change-status.html" %}
                            {% endif %}
                            <p class="card-text">{{ event.date }}</p>
                        </div>
                    </div>
                {% endfor %}
            {% if rest_events_count > 0 %}
                <p class="text-muted">...и еще {{ rest_events_count }} событие(-ий)</p>
                {% endif %}
            </div>
        </div>
    {% endif %}

    {% if report.comments.count > 0 %}
        <div class="container">
            <!-- Comments -->
            <h2 class="ma-5">Комментарии <i class="fa fa-comments" aria-hidden="true"></i></h2>
            {% for comment in report.comments.all %}
                {% include "reports/comment.html" %}
            {% endfor %}
        </div>
    {% endif %}

    <div class="container ma-5">
        <!-- Write a comment -->
        <form action="{% url "comment" %}" method="post">
            {{ form.content }}
            <input type="hidden" name="report_id" value="{{ report.id }}" id="id_report_id">
            {% csrf_token %}
            <button type="submit" class="btn btn-primary">Отправить</button>
        </form>
    </div>
{% endblock %}